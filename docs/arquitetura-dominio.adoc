= Arquitetura da Camada de Dom√≠nio
:doctype: article
:encoding: utf-8
:lang: pt-BR
:toc: left
:toclevels: 3
:numbered:
:source-highlighter: coderay
:icons: font

== Vis√£o Geral da Camada de Dom√≠nio

A camada de dom√≠nio (`src/Domain`) implementa os conceitos centrais do **Domain-Driven Design (DDD)**, concentrando toda a l√≥gica de neg√≥cio e regras fundamentais da aplica√ß√£o. Esta camada √© **completamente independente** de frameworks e tecnologias de infraestrutura.

=== Princ√≠pios Arquiteturais

[cols="3,7"]
|===
|Princ√≠pio |Implementa√ß√£o

|*Clean Architecture* 
|Dom√≠nio no centro, sem depend√™ncias externas

|*Domain-Driven Design* 
|Modelagem baseada no dom√≠nio de neg√≥cio

|*SOLID Principles* 
|Interfaces bem definidas, responsabilidades √∫nicas

|*Tell Don't Ask* 
|Entidades com comportamentos, n√£o apenas dados

|*Object Calisthenics* 
|Classes pequenas, sem getters/setters desnecess√°rios
|===

== Estrutura Detalhada dos Contextos

=== 1. Diagrama da Arquitetura de Dom√≠nio

[source,text]
----
src/Domain/
‚îú‚îÄ‚îÄ Auth/                        ‚óÑ‚îÄ‚îÄ CONTEXTO: Autentica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ Commands/               
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Impl/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ LoginCommand.php         ‚óÑ‚îÄ‚îÄ Command Pattern
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ChangePasswordCommand.php
‚îÇ   ‚îî‚îÄ‚îÄ DTOs/
‚îÇ       ‚îî‚îÄ‚îÄ Impl/
‚îÇ           ‚îú‚îÄ‚îÄ LoginDataDTO.php         ‚óÑ‚îÄ‚îÄ Data Transfer Objects
‚îÇ           ‚îî‚îÄ‚îÄ ChangePasswordDataDTO.php
‚îÇ
‚îú‚îÄ‚îÄ Security/                    ‚óÑ‚îÄ‚îÄ CONTEXTO: Seguran√ßa/Usu√°rios
‚îÇ   ‚îú‚îÄ‚îÄ Entities/               
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserEntityInterface.php      ‚óÑ‚îÄ‚îÄ Interface da Entidade
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Impl/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ UserEntity.php           ‚óÑ‚îÄ‚îÄ Entidade Rica em Comportamentos
‚îÇ   ‚îú‚îÄ‚îÄ Repositories/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserRepositoryInterface.php  ‚óÑ‚îÄ‚îÄ Repository Pattern
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Impl/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ UserRepository.php       ‚óÑ‚îÄ‚îÄ Implementa√ß√£o Doctrine
‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserServiceInterface.php     ‚óÑ‚îÄ‚îÄ Servi√ßos de Dom√≠nio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthServiceInterface.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Impl/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ UserService.php          ‚óÑ‚îÄ‚îÄ L√≥gica de Neg√≥cio
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ AuthService.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ UserValidationService.php
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ AuthValidationService.php
‚îÇ   ‚îú‚îÄ‚îÄ Commands/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Impl/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ CreateUserCommand.php    ‚óÑ‚îÄ‚îÄ Command Objects
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ UpdateUserCommand.php
‚îÇ   ‚îú‚îÄ‚îÄ DTOs/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Impl/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ AbstractBaseUserDataDTO.php ‚óÑ‚îÄ‚îÄ DTO Base
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ CreateUserDataDTO.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ UpdateUserDataDTO.php
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ BaseUserDataDTO.php
‚îÇ   ‚îî‚îÄ‚îÄ Validators/
‚îÇ       ‚îú‚îÄ‚îÄ UserDataValidatorInterface.php
‚îÇ       ‚îú‚îÄ‚îÄ AuthDataValidatorInterface.php
‚îÇ       ‚îî‚îÄ‚îÄ Impl/
‚îÇ           ‚îú‚îÄ‚îÄ UserDataValidator.php    ‚óÑ‚îÄ‚îÄ Valida√ß√£o de Dom√≠nio
‚îÇ           ‚îî‚îÄ‚îÄ AuthDataValidator.php
‚îÇ
‚îú‚îÄ‚îÄ System/                      ‚óÑ‚îÄ‚îÄ CONTEXTO: Sistema
‚îÇ   ‚îî‚îÄ‚îÄ Services/
‚îÇ       ‚îú‚îÄ‚îÄ SystemServiceInterface.php
‚îÇ       ‚îú‚îÄ‚îÄ SystemResponseServiceInterface.php
‚îÇ       ‚îî‚îÄ‚îÄ Impl/
‚îÇ           ‚îú‚îÄ‚îÄ SystemService.php        ‚óÑ‚îÄ‚îÄ Servi√ßos de Sistema
‚îÇ           ‚îî‚îÄ‚îÄ SystemResponseService.php
‚îÇ
‚îî‚îÄ‚îÄ Common/                      ‚óÑ‚îÄ‚îÄ CONTEXTO: Recursos Compartilhados
    ‚îú‚îÄ‚îÄ Entities/
    ‚îÇ   ‚îî‚îÄ‚îÄ Behaviors/                   ‚óÑ‚îÄ‚îÄ Behavior Pattern
    ‚îÇ       ‚îú‚îÄ‚îÄ TimestampableBehaviorInterface.php
    ‚îÇ       ‚îú‚îÄ‚îÄ SoftDeletableBehaviorInterface.php
    ‚îÇ       ‚îú‚îÄ‚îÄ UuidableBehaviorInterface.php
    ‚îÇ       ‚îî‚îÄ‚îÄ Impl/
    ‚îÇ           ‚îú‚îÄ‚îÄ TimestampableBehavior.php    ‚óÑ‚îÄ‚îÄ Comportamentos Reutiliz√°veis
    ‚îÇ           ‚îú‚îÄ‚îÄ SoftDeletableBehavior.php
    ‚îÇ           ‚îî‚îÄ‚îÄ UuidableBehavior.php
    ‚îú‚îÄ‚îÄ Exceptions/
    ‚îÇ   ‚îú‚îÄ‚îÄ BaseExceptionInterface.php
    ‚îÇ   ‚îú‚îÄ‚îÄ BusinessLogicExceptionInterface.php
    ‚îÇ   ‚îú‚îÄ‚îÄ ValidationExceptionInterface.php
    ‚îÇ   ‚îî‚îÄ‚îÄ Impl/
    ‚îÇ       ‚îú‚îÄ‚îÄ AbstractBaseException.php        ‚óÑ‚îÄ‚îÄ Hierarquia de Exce√ß√µes
    ‚îÇ       ‚îú‚îÄ‚îÄ BusinessLogicExceptionAbstract.php
    ‚îÇ       ‚îî‚îÄ‚îÄ ValidationException.php
    ‚îú‚îÄ‚îÄ Repositories/
    ‚îÇ   ‚îú‚îÄ‚îÄ AbstractRepositoryInterface.php
    ‚îÇ   ‚îî‚îÄ‚îÄ Impl/
    ‚îÇ       ‚îî‚îÄ‚îÄ AbstractRepository.php           ‚óÑ‚îÄ‚îÄ Repository Base
    ‚îú‚îÄ‚îÄ Services/
    ‚îÇ   ‚îú‚îÄ‚îÄ AbstractServiceInterface.php
    ‚îÇ   ‚îî‚îÄ‚îÄ Impl/
    ‚îÇ       ‚îî‚îÄ‚îÄ AbstractService.php              ‚óÑ‚îÄ‚îÄ Service Base
    ‚îú‚îÄ‚îÄ Validators/
    ‚îÇ   ‚îú‚îÄ‚îÄ ValidatorInterface.php
    ‚îÇ   ‚îú‚îÄ‚îÄ EmailValidatorInterface.php
    ‚îÇ   ‚îî‚îÄ‚îÄ Impl/
    ‚îÇ       ‚îî‚îÄ‚îÄ EmailValidator.php               ‚óÑ‚îÄ‚îÄ Validadores Espec√≠ficos
    ‚îî‚îÄ‚îÄ ValueObjects/                            ‚óÑ‚îÄ‚îÄ Value Objects (DDD)
        ‚îú‚îÄ‚îÄ ModuleName/
        ‚îú‚îÄ‚îÄ Priority/
        ‚îî‚îÄ‚îÄ RoutePrefix/
----

=== 2. Contexto Security (Usu√°rios)

==== 2.1 Entidade UserEntity - Rica em Comportamentos

[source,php]
----
final class UserEntity implements UserEntityInterface, JsonSerializable
{
    // ‚úÖ Propriedades p√∫blicas (Object Calisthenics - evitar getters)
    public int $id;
    public string $name;
    public string $email;
    public string $password;
    public string $role;
    public string $status;
    public DateTime $createdAt;
    public DateTime $updatedAt;
    public ?string $uuid;

    // ‚úÖ Behaviors compostos (SRP)
    private TimestampableBehaviorInterface $timestampableBehavior;
    private UuidableBehaviorInterface $uuidableBehavior;

    // ‚úÖ M√âTODOS COMPORTAMENTAIS (Tell, Don't Ask)
    
    public function authenticate(string $password): bool
    {
        if (!$this->isActive()) {
            return false;
        }
        return $this->verifyPassword($password);
    }

    public function activate(): self
    {
        $this->status = 'active';
        $this->touchEntity();
        return $this;
    }

    public function deactivate(): self
    {
        $this->status = 'inactive';
        $this->touchEntity();
        return $this;
    }

    public function updatePassword(string $newPassword): self
    {
        $this->password = password_hash($newPassword, PASSWORD_DEFAULT);
        $this->touchEntity();
        return $this;
    }

    public function updateProfile(array $profileData): self
    {
        // L√≥gica de atualiza√ß√£o de perfil
        $this->touchEntity();
        return $this;
    }

    // ‚úÖ REGRAS DE NEG√ìCIO NA ENTIDADE
    
    public function canPerform(string $action): bool
    {
        if (!$this->isActive()) {
            return false;
        }
        
        switch ($this->role) {
            case 'admin': return true;
            case 'user': return in_array($action, ['view', 'edit_own']);
            default: return false;
        }
    }

    public function needsPasswordChange(): bool
    {
        $ninetyDaysAgo = (new DateTime())->modify('-90 days');
        return $this->updatedAt < $ninetyDaysAgo;
    }

    public function canBePromotedToAdmin(): bool
    {
        return $this->isActive() && !$this->isAdmin();
    }
}
----

**Caracter√≠sticas da Entidade:**

- **Rica em Comportamentos**: M√©todos que encapsulam regras de neg√≥cio
- **Object Calisthenics**: Propriedades p√∫blicas, evita getters desnecess√°rios
- **Tell Don't Ask**: Cliente manda a entidade fazer algo, n√£o pergunta estado
- **Composition over Inheritance**: Usa behaviors como composi√ß√£o
- **SRP**: Cada m√©todo tem uma responsabilidade espec√≠fica

==== 2.2 UserService - Coordena√ß√£o de Casos de Uso

[source,php]
----
final class UserService extends AbstractService implements UserServiceInterface
{
    private EmailValidatorInterface $emailValidator;

    // ‚úÖ CASOS DE USO PRINCIPAIS
    
    public function createUser(CreateUserDataDTO $data): UserEntityInterface
    {
        // 1. Valida√ß√µes de dom√≠nio
        $this->validateEmail($data->email);
        $this->validateEmailAvailabilityOrThrow($data->email);
        $this->validatePassword($data->password);
        $this->validateRole($data->role);

        // 2. Cria√ß√£o da entidade
        $user = new UserEntity(
            $data->name,
            $data->email,
            $data->password,
            $data->role,
            'active'
        );

        // 3. Persist√™ncia
        return $this->repository->save($user);
    }

    public function updateUser(int $id, UpdateUserDataDTO $data): UserEntityInterface
    {
        return $this->processUserById($id, function($user) use ($data) {
            // Valida√ß√µes usando DTO readonly
            if ($data->email !== null) {
                $this->validateEmail($data->email);
                if ($data->email !== $user->email) {
                    $this->validateEmailAvailabilityOrThrow($data->email, $id);
                }
            }

            // Profile updates (Tell, Don't Ask)
            $profileData = $data->toArray();
            $profileFields = ['name', 'email', 'role'];
            $profileUpdate = array_intersect_key($profileData, 
                                array_flip($profileFields));
            if (!empty($profileUpdate)) {
                $user->updateProfile($profileUpdate);
            }

            // Password update
            if ($data->password !== null) {
                $user->updatePassword($data->password);
            }

            return $this->repository->save($user);
        });
    }

    // ‚úÖ M√âTODOS COMPORTAMENTAIS DE ALTO N√çVEL
    
    public function promoteToAdmin(int $userId): ?UserEntityInterface
    {
        return $this->processUserById($userId, function($user) {
            if ($user->isAdmin()) {
                return $user;
            }
            
            $user->updateProfile(['role' => 'admin']);
            return $this->saveUser($user);
        });
    }

    public function deactivateInactiveUsers(int $daysInactive = 90): array
    {
        return $this->processAllUsers(function($user) {
            if ($user->isActive() && $user->needsPasswordChange()) {
                $user->deactivate();
                $this->saveUser($user);
                return $user;
            }
            return null;
        });
    }
}
----

**Caracter√≠sticas do Service:**

- **Orquestra√ß√£o**: Coordena entidades, reposit√≥rios e valida√ß√µes
- **Use Cases**: Cada m√©todo p√∫blico representa um caso de uso
- **Tell Don't Ask**: Diz √†s entidades o que fazer
- **DTO Usage**: Usa DTOs para transfer data de forma type-safe
- **Error Handling**: Tratamento centralizado de exce√ß√µes de dom√≠nio

==== 2.3 Commands - Encapsulamento de Opera√ß√µes

[source,php]
----
final class CreateUserCommand
{
    private CreateUserDataDTO $data;
    
    public function __construct(CreateUserDataDTO $data)
    {
        $this->data = $data;
    }

    // ‚úÖ EXECU√á√ÉO ENCAPSULADA (Command Pattern)
    public function executeWith(UserServiceInterface $userService): UserEntityInterface
    {
        return $userService->createUser($this->data);
    }

    // ‚úÖ FACTORY METHOD
    public static function fromArray(array $data): self
    {
        return new self(CreateUserDataDTO::fromArray($data));
    }
}
----

**Vantagens dos Commands:**

- **Command Pattern**: Encapsula opera√ß√£o como objeto
- **Reusabilidade**: Pode ser usado em diferentes contextos
- **Testabilidade**: Facilita testes unit√°rios
- **Queue Support**: Pode ser facilmente enfileirado

==== 2.4 DTOs - Transfer Objects Type-Safe

[source,php]
----
// ‚úÖ DTO BASE ABSTRATO (DRY Principle)
abstract class AbstractBaseUserDataDTO
{
    public ?string $name;
    public ?string $email;
    public ?string $password;
    public ?string $role;

    public function __construct(
        ?string $name = null,
        ?string $email = null,
        ?string $password = null,
        ?string $role = null
    ) {
        $this->name = $name;
        $this->email = $email;
        $this->password = $password;
        $this->role = $role;
    }
}

// ‚úÖ DTO ESPEC√çFICO PARA CRIA√á√ÉO
final class CreateUserDataDTO extends AbstractBaseUserDataDTO
{
    // Garante que dados de cria√ß√£o s√£o obrigat√≥rios
    public function __construct(
        string $name,
        string $email,
        string $password,
        string $role = 'user'
    ) {
        parent::__construct($name, $email, $password, $role);
    }

    public static function fromArray(array $data): self
    {
        return new self(
            $data['name'] ?? '',
            $data['email'] ?? '',
            $data['password'] ?? '',
            $data['role'] ?? 'user'
        );
    }
}
----

=== 3. Contexto Auth (Autentica√ß√£o)

==== 3.1 AuthService - Casos de Uso de Autentica√ß√£o

[source,php]
----
final class AuthService implements AuthServiceInterface
{
    private UserServiceInterface $userService;

    // ‚úÖ AUTENTICA√á√ÉO COM DTO
    public function authenticate(LoginDataDTO $credentials): ?UserEntityInterface
    {
        $user = $this->userService->getUserByEmail($credentials->email);
        if (!$user) {
            return null;
        }

        // Usa comportamento da entidade (Tell, Don't Ask)
        if ($user->authenticate($credentials->password)) {
            return $user;
        }

        return null;
    }

    // ‚úÖ MUDAN√áA DE SENHA COM DTO
    public function changePassword(ChangePasswordDataDTO $data): ?UserEntityInterface
    {
        $user = $this->userService->processUserById($data->userId, fn($user) => $user);
        if (!$user) {
            return null;
        }

        // Valida senha atual
        if (!$user->authenticate($data->currentPassword)) {
            return null;
        }
        
        // Atualiza senha (Tell, Don't Ask)
        $user->updatePassword($data->newPassword);
        
        return $this->userService->saveUser($user);
    }

    // ‚úÖ M√âTODOS COMPORTAMENTAIS
    public function authenticateWithPermissions(
        string $email, 
        string $password, 
        string $requiredAction
    ): array {
        $user = $this->userService->getUserByEmail($email);
        if (!$user || !$user->authenticate($password)) {
            return [
                'success' => false,
                'message' => 'Credenciais inv√°lidas',
                'canPerform' => false
            ];
        }
        
        return [
            'success' => true,
            'user' => $user,
            'canPerform' => $user->canPerform($requiredAction),
            'needsPasswordChange' => $user->needsPasswordChange()
        ];
    }
}
----

=== 4. Contexto Common - Infraestrutura Compartilhada

==== 4.1 Behaviors - Composi√ß√£o de Comportamentos

[source,php]
----
// ‚úÖ BEHAVIOR INTERFACE
interface TimestampableBehaviorInterface
{
    public function getCreatedAtFormatted(string $format = 'Y-m-d H:i:s'): string;
    public function getUpdatedAtFormatted(string $format = 'Y-m-d H:i:s'): string;
    public function wasCreatedRecently(): bool;
    public function wasUpdatedRecently(): bool;
    public function getAgeInDays(): int;
    public function touch(): self;
}

// ‚úÖ BEHAVIOR IMPLEMENTATION
final class TimestampableBehavior implements TimestampableBehaviorInterface
{
    private DateTime $createdAt;
    private DateTime $updatedAt;

    public function wasCreatedRecently(): bool
    {
        $oneDayAgo = (new DateTime())->modify('-1 day');
        return $this->createdAt > $oneDayAgo;
    }

    public function getAgeInDays(): int
    {
        $now = new DateTime();
        return (int) $this->createdAt->diff($now)->days;
    }

    public function touch(): self
    {
        $this->updatedAt = new DateTime();
        return $this;
    }
}
----

**Vantagens dos Behaviors:**

- **Composition over Inheritance**: Evita hierarquias complexas
- **SRP**: Cada behavior tem uma responsabilidade espec√≠fica
- **Reusabilidade**: Pode ser usado em m√∫ltiplas entidades
- **Testabilidade**: F√°cil de testar isoladamente

==== 4.2 Exception Hierarchy - Tratamento de Erros

[source,php]
----
// ‚úÖ BASE EXCEPTION
abstract class AbstractBaseException extends Exception implements BaseExceptionInterface
{
    protected array $context = [];

    public function getContext(): array
    {
        return $this->context;
    }

    public function addContext(string $key, $value): self
    {
        $this->context[$key] = $value;
        return $this;
    }
}

// ‚úÖ VALIDATION EXCEPTION
final class ValidationException extends AbstractBaseException 
    implements ValidationExceptionInterface
{
    private array $errors = [];

    public function __construct(string $message = "Validation failed", 
                                array $errors = [], int $code = 422)
    {
        parent::__construct($message, $code);
        $this->errors = $errors;
    }

    public function addError(string $field, string $message): self
    {
        $this->errors[$field][] = $message;
        return $this;
    }

    public function getErrors(): array
    {
        return $this->errors;
    }
}
----

==== 4.3 Repository Pattern - Abstra√ß√£o de Dados

[source,php]
----
// ‚úÖ REPOSITORY INTERFACE
interface AbstractRepositoryInterface
{
    public function find(int $id): ?object;
    public function findAll(): array;
    public function findBy(array $criteria): array;
    public function findOneBy(array $criteria): ?object;
    public function save(object $entity): object;
    public function delete(object $entity): bool;
    public function count(array $criteria = []): int;
}

// ‚úÖ ABSTRACT REPOSITORY
abstract class AbstractRepository implements AbstractRepositoryInterface
{
    protected EntityManagerInterface $entityManager;

    // ‚úÖ M√âTODOS B√ÅSICOS CRUD
    public function find(int $id): ?object
    {
        return $this->entityManager->find($this->getEntityClass(), $id);
    }

    public function save(object $entity): object
    {
        $this->entityManager->persist($entity);
        $this->entityManager->flush();
        return $entity;
    }

    // ‚úÖ QUERY BUILDER SUPPORT
    protected function createQueryBuilder(string $alias): QueryBuilder
    {
        return $this->entityManager
                   ->createQueryBuilder()
                   ->select($alias)
                   ->from($this->getEntityClass(), $alias);
    }

    abstract protected function getEntityClass(): string;
}

// ‚úÖ CONCRETE REPOSITORY
final class UserRepository extends AbstractRepository 
    implements UserRepositoryInterface
{
    public function findByEmail(string $email): ?UserEntityInterface
    {
        return $this->findOneBy(['email' => $email]);
    }

    public function searchByName(string $name): array
    {
        $qb = $this->createQueryBuilder('u');
        $qb->where('u.name LIKE :name')
           ->setParameter('name', '%' . $name . '%');
        return $qb->getQuery()->getResult();
    }

    protected function getEntityClass(): string
    {
        return UserEntity::class;
    }
}
----

=== 5. Sistema de Valida√ß√£o de Dom√≠nio

==== 5.1 Validators - Valida√ß√£o Espec√≠fica

[source,php]
----
// ‚úÖ VALIDATOR INTERFACE
interface ValidatorInterface
{
    public function validate($data): bool;
    public function getErrorMessage(): string;
}

// ‚úÖ EMAIL VALIDATOR
final class EmailValidator implements EmailValidatorInterface
{
    private string $errorMessage = '';

    public function validate($email): bool
    {
        if (!is_string($email)) {
            $this->errorMessage = 'Email deve ser uma string';
            return false;
        }

        if (empty($email)) {
            $this->errorMessage = 'Email √© obrigat√≥rio';
            return false;
        }

        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            $this->errorMessage = 'Formato de email inv√°lido';
            return false;
        }

        if (!$this->validateEmailDomain($email)) {
            $this->errorMessage = 'Dom√≠nio de email n√£o permitido';
            return false;
        }

        return true;
    }

    private function validateEmailDomain(string $email): bool
    {
        $domain = substr(strrchr($email, '@'), 1);
        $blockedDomains = ['tempmail.com', '10minutemail.com'];
        return !in_array($domain, $blockedDomains);
    }
}
----

== Padr√µes e Pr√°ticas Implementados

=== 1. Domain-Driven Design (DDD)

[cols="3,7"]
|===
|Conceito DDD |Implementa√ß√£o

|*Entities* 
|UserEntity com identidade e comportamentos ricos

|*Value Objects* 
|ModuleName, Priority, RoutePrefix (imut√°veis)

|*Domain Services* 
|UserService, AuthService (l√≥gica que n√£o pertence √†s entidades)

|*Repositories* 
|UserRepository (abstra√ß√£o do acesso a dados)

|*Aggregates* 
|User como aggregate root

|*Domain Events* 
|Preparado para eventos de dom√≠nio (futura expans√£o)

|*Bounded Contexts* 
|Auth, Security, System como contextos separados
|===

=== 2. Object Calisthenics

[cols="3,7"]
|===
|Regra |Implementa√ß√£o

|*One level of indentation* 
|M√©todos pequenos com guard clauses

|*Don't use ELSE* 
|Early returns e guard clauses

|*Wrap primitives* 
|DTOs encapsulam dados primitivos

|*First class collections* 
|Arrays encapsulados em m√©todos espec√≠ficos

|*One dot per line* 
|Evita method chaining excessivo

|*Don't abbreviate* 
|Nomes completos e descritivos

|*Keep entities small* 
|Classes focadas, m√°ximo 50 linhas

|*No getters/setters* 
|Propriedades p√∫blicas quando apropriado, m√©todos comportamentais
|===

=== 3. SOLID Principles

==== Single Responsibility Principle (SRP)
- Cada classe tem **uma √∫nica raz√£o para mudar**
- UserEntity: representa usu√°rio e seus comportamentos
- UserService: coordena casos de uso de usu√°rios
- AuthService: casos de uso de autentica√ß√£o
- Validators: valida√ß√£o espec√≠fica

==== Open/Closed Principle (OCP)
- **Aberto para extens√£o**: Novos behaviors, validators, services
- **Fechado para modifica√ß√£o**: Classes existentes n√£o mudam

==== Liskov Substitution Principle (LSP)
- Interfaces bem definidas permitem substitui√ß√£o
- UserEntityInterface pode ser implementada por diferentes entidades
- AbstractRepository pode ser estendido sem quebrar contratos

==== Interface Segregation Principle (ISP)
- Interfaces espec√≠ficas e pequenas
- Clients n√£o dependem de m√©todos que n√£o usam
- Separa√ß√£o entre UserServiceInterface, AuthServiceInterface

==== Dependency Inversion Principle (DIP)
- Services dependem de interfaces (abstra√ß√µes)
- N√£o dependem de implementa√ß√µes concretas
- Repository pattern implementa DIP perfeitamente

=== 4. Tell Don't Ask

==== ‚ùå **Anti-Pattern (Ask)**
[source,php]
----
// MAL: Cliente pergunta estado e decide o que fazer
if ($user->getStatus() === 'active' && $user->getRole() === 'admin') {
    $user->setCanPerform(true);
}
----

==== ‚úÖ **Pattern Correto (Tell)**
[source,php]
----
// BOM: Cliente manda entidade fazer algo
$canPerform = $user->canPerform('admin_action');

// BOM: Cliente manda entidade mudar de estado
$user->activate();
$user->promoteToAdmin();
----

== Fluxo Completo: Caso de Uso "Criar Usu√°rio"

=== Sequ√™ncia Detalhada

[source,text]
----
1. üìã CONTROLLER recebe dados HTTP
   ‚îÇ
   ‚îú‚îÄ‚îÄ Valida formato b√°sico
   ‚îú‚îÄ‚îÄ Cria CreateUserDataDTO
   ‚îî‚îÄ‚îÄ Chama UserService->createUser()
   
2. üè≠ COMMAND CREATION (Opcional)
   ‚îÇ
   ‚îú‚îÄ‚îÄ CreateUserCommand::fromArray($data)
   ‚îú‚îÄ‚îÄ Encapsula opera√ß√£o como objeto
   ‚îî‚îÄ‚îÄ Command->executeWith(UserService)
   
3. üéØ USER SERVICE (Domain Layer)
   ‚îÇ
   ‚îú‚îÄ‚îÄ validateEmail() usando EmailValidator
   ‚îú‚îÄ‚îÄ validateEmailAvailabilityOrThrow() 
   ‚îú‚îÄ‚îÄ validatePassword() (regras de neg√≥cio)
   ‚îú‚îÄ‚îÄ validateRole() (roles v√°lidas)
   ‚îú‚îÄ‚îÄ new UserEntity() com dados do DTO
   ‚îî‚îÄ‚îÄ repository->save($user)
   
4. üèõÔ∏è USER ENTITY (Rich Domain Model)
   ‚îÇ
   ‚îú‚îÄ‚îÄ __construct() initializes:
   ‚îÇ   ‚îú‚îÄ‚îÄ TimestampableBehavior (createdAt/updatedAt)
   ‚îÇ   ‚îú‚îÄ‚îÄ UuidableBehavior (gera UUID)
   ‚îÇ   ‚îú‚îÄ‚îÄ password_hash() da senha
   ‚îÇ   ‚îî‚îÄ‚îÄ status = 'active'
   ‚îú‚îÄ‚îÄ generateUuid() se necess√°rio
   ‚îî‚îÄ‚îÄ Entidade preparada para persist√™ncia
   
5. üìä USER REPOSITORY (Data Access)
   ‚îÇ
   ‚îú‚îÄ‚îÄ AbstractRepository->save()
   ‚îú‚îÄ‚îÄ EntityManager->persist($entity)
   ‚îú‚îÄ‚îÄ EntityManager->flush()
   ‚îî‚îÄ‚îÄ Retorna UserEntity com ID do banco
   
6. ‚úÖ RESPONSE (Success Path)
   ‚îÇ
   ‚îú‚îÄ‚îÄ UserEntity convertida para JSON
   ‚îú‚îÄ‚îÄ ApiResponse padronizada
   ‚îî‚îÄ‚îÄ HTTP 201 Created

üî• EXCEPTION FLOW (Error Path)
   ‚îÇ
   ‚îú‚îÄ‚îÄ ValidationException ‚Üí HTTP 422
   ‚îú‚îÄ‚îÄ BusinessLogicException ‚Üí HTTP 400  
   ‚îú‚îÄ‚îÄ DatabaseException ‚Üí HTTP 500
   ‚îî‚îÄ‚îÄ Middleware converte para JSON padronizado
----

=== C√≥digo Exemplo Completo

[source,php]
----
// ‚úÖ 1. CONTROLLER LAYER (Application)
final class UserController extends AbstractBaseController
{
    public function create(ServerRequestInterface $request, 
                          ResponseInterface $response): ResponseInterface
    {
        try {
            $data = $request->getParsedBody();
            
            // Criar Command
            $command = CreateUserCommand::fromArray($data);
            
            // Executar via Service
            $user = $command->executeWith($this->userService);
            
            // Resposta padronizada
            $apiResponse = $this->success($user, 'Usu√°rio criado com sucesso');
            $response->getBody()->write($apiResponse->toJson());
            return $response->withStatus(201);
            
        } catch (ValidationException $e) {
            $apiResponse = $this->error($e->getMessage(), 422, $e->getErrors());
            $response->getBody()->write($apiResponse->toJson());
            return $response->withStatus(422);
        }
    }
}

// ‚úÖ 2. DOMAIN SERVICE
final class UserService implements UserServiceInterface 
{
    public function createUser(CreateUserDataDTO $data): UserEntityInterface
    {
        // Valida√ß√µes de dom√≠nio
        $this->validateEmail($data->email);
        $this->validateEmailAvailabilityOrThrow($data->email);
        $this->validatePassword($data->password);
        $this->validateRole($data->role);

        // Cria√ß√£o da entidade (Tell, Don't Ask)
        $user = new UserEntity(
            $data->name,
            $data->email, 
            $data->password,
            $data->role
        );

        // Persist√™ncia
        return $this->repository->save($user);
    }
}

// ‚úÖ 3. DOMAIN ENTITY
final class UserEntity implements UserEntityInterface
{
    public function __construct(string $name, string $email, 
                               string $password, string $role = 'user')
    {
        // Inicializa√ß√£o de behaviors
        $this->timestampableBehavior = new TimestampableBehavior();
        $this->uuidableBehavior = new UuidableBehavior();
        
        // Dados b√°sicos
        $this->name = $name;
        $this->email = $email;
        $this->password = password_hash($password, PASSWORD_DEFAULT);
        $this->role = $role;
        $this->status = 'active';
        
        // Timestamps e UUID
        $this->createdAt = new DateTime();
        $this->updatedAt = new DateTime();
        $this->generateUuid();
    }
    
    // Comportamentos ricos
    public function activate(): self { /* ... */ }
    public function canPerform(string $action): bool { /* ... */ }
    public function needsPasswordChange(): bool { /* ... */ }
}
----

== Benef√≠cios da Arquitetura

=== 1. **Testabilidade**
- Domain Layer **independente** de frameworks
- Mocks f√°ceis via interfaces
- Testes unit√°rios **r√°pidos** e **confi√°veis**

=== 2. **Manutenibilidade**  
- L√≥gica de neg√≥cio **centralizada** no dom√≠nio
- Mudan√ßas de regras **isoladas** da infraestrutura
- **C√≥digo expressivo** que reflete o neg√≥cio

=== 3. **Flexibilidade**
- F√°cil **troca de implementa√ß√µes**
- **Extensibilidade** via novos services/entities
- **Evolu√ß√£o** sem quebrar c√≥digo existente

=== 4. **Performance**
- Repository pattern com **query builders** otimizados
- Lazy loading do Doctrine
- **Caching** em camadas superiores

=== 5. **Consist√™ncia**
- **Padr√µes uniformes** em toda aplica√ß√£o
- **Valida√ß√£o centralizada** de regras
- **Exception handling** padronizado

== Considera√ß√µes Finais

### Compatibilidade PHP 7.4
- **Typed properties**: Todas as propriedades tipadas
- **Return types**: Todos os m√©todos com tipos de retorno
- **Strict types**: `declare(strict_types=1)` em todos os arquivos
- **Null coalescing**: Uso de `??` onde apropriado

### Pr√≥ximas Expans√µes
- **Domain Events**: Implementar eventos de dom√≠nio
- **Specifications**: Pattern para queries complexas  
- **Value Objects**: Expandir uso de objetos de valor
- **Aggregates**: Definir aggregates mais complexos

### M√©tricas de Qualidade
- **Cobertura de testes**: Objetivo >90%
- **Complexidade ciclom√°tica**: M√°ximo 10 por m√©todo
- **Acoplamento**: Baixo via dependency injection
- **Coes√£o**: Alta dentro de cada contexto

---

*Documento gerado automaticamente a partir da an√°lise completa da camada de dom√≠nio em 24/09/2025*
